name: "Shortcut: @ready"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  statuses: write

jobs:
  detect:
    name: Detect @ready Command
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      is_pr: ${{ steps.check.outputs.is_pr }}

    steps:
      - name: Check for @ready command
        id: check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const commentBody = context.payload.comment?.body || '';
            const shouldRun = commentBody.includes('@ready');

            console.log(`Comment body: ${commentBody}`);
            console.log(`Should run: ${shouldRun}`);

            core.setOutput('should_run', shouldRun);

            if (!shouldRun) {
              return;
            }

            const issueNumber = context.payload.issue.number;
            const isPR = !!context.payload.issue.pull_request;

            core.setOutput('issue_number', issueNumber);
            core.setOutput('is_pr', isPR);

            // Add reaction to indicate processing
            if (context.payload.comment?.id) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            }

  check-issue-resolved:
    name: Check if Issue Resolved in Codebase
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.detect.outputs.should_run == 'true' && needs.detect.outputs.is_pr == 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Claude Check Issue Resolution
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ‚úÖ CHECK IF ISSUE IS RESOLVED IN CODEBASE

            **Issue:** #${{ needs.detect.outputs.issue_number }}

            ## YOUR MISSION - VERIFY ISSUE RESOLUTION:

            ### 1. Fetch Issue Details
            ```bash
            gh issue view ${{ needs.detect.outputs.issue_number }} --json title,body,labels
            ```

            ### 2. Understand What Was Requested
            - Read the issue title and body completely
            - Identify the specific problem or feature request
            - Note any acceptance criteria mentioned

            ### 3. Search Codebase for Implementation

            **A. Search for related code:**
            - Search for keywords from the issue title
            - Look for recently modified files
            - Check commit history for references

            **B. Check recent commits:**
            ```bash
            git log --all --grep="#${{ needs.detect.outputs.issue_number }}" --oneline
            git log --since="1 month ago" --all --oneline
            ```

            **C. Search for implementation patterns:**
            - If bug: Search for the buggy code and check if fixed
            - If feature: Search for new code matching the feature
            - If docs: Check if documentation was added

            ### 4. Verify Implementation

            **For Bugs:**
            - [ ] Bug no longer reproducible
            - [ ] Fix addresses root cause (not just symptom)
            - [ ] Tests added to prevent regression

            **For Features:**
            - [ ] Feature implemented as described
            - [ ] Meets acceptance criteria
            - [ ] Has tests
            - [ ] Has documentation

            **For Enhancements:**
            - [ ] Enhancement implemented
            - [ ] Maintains backward compatibility
            - [ ] Follows CLAUDE.md guidelines

            ### 5. Test the Implementation (if exists)
            ```bash
            pnpm biome check .
            pnpm tsc --noEmit
            pnpm test --passWithNoTests
            pnpm expo export:web
            ```

            ### 6. Report Results

            Comment on the issue with your findings:
            ```bash
            gh issue comment ${{ needs.detect.outputs.issue_number }} --body "$(cat <<'EOF'
            ## ‚úÖ Readiness Check Complete

            ### Resolution Status: [RESOLVED/PARTIALLY RESOLVED/NOT RESOLVED/DUPLICATE]

            ### Analysis
            [Detailed explanation of what you found]

            ### Evidence
            - **Implementation Found:** [Yes/No]
            - **Files Modified:** [List files if found]
            - **Commits:** [List relevant commits if found]
            - **Tests Added:** [Yes/No]
            - **Documentation Updated:** [Yes/No]

            ### Verification Results
            - [x] Biome linting: [PASS/FAIL]
            - [x] TypeScript check: [PASS/FAIL]
            - [x] Tests: [PASS/FAIL]
            - [x] Build: [PASS/FAIL]

            ### Recommendation

            [Choose one and fill in details:]

            #### ‚úÖ READY TO CLOSE
            This issue has been fully resolved. The implementation:
            - [What was implemented]
            - [How it addresses the issue]
            - [Where it can be found]

            **Suggested action:** Close this issue

            #### ‚ö†Ô∏è PARTIALLY RESOLVED
            Some progress has been made but not complete:
            - [What's done]
            - [What's still needed]

            **Suggested action:** Update issue with remaining work

            #### ‚ùå NOT RESOLVED
            No implementation found in the codebase.
            - [Searched for: X]
            - [Checked commits: X]
            - [No matching implementation found]

            **Suggested action:** Keep issue open, consider auto-implementation

            #### üîÑ DUPLICATE
            This appears to be a duplicate of #X
            - [Why it's a duplicate]

            **Suggested action:** Close as duplicate

            ---

            ü§ñ *Executed via @ready shortcut - Issue resolution check*
            EOF
            )"
            ```

            ### 7. Auto-Close if Fully Resolved

            If the issue is FULLY RESOLVED:
            ```bash
            gh issue close ${{ needs.detect.outputs.issue_number }} --comment "Auto-closing as resolved. Implementation verified in codebase."
            ```

            If it's a DUPLICATE:
            ```bash
            gh issue close ${{ needs.detect.outputs.issue_number }} --comment "Closing as duplicate of #<number>"
            ```

            ## CRITICAL RULES:
            - **BE THOROUGH** - Actually search the codebase comprehensively
            - **BE HONEST** - If not resolved, say so clearly
            - **PROVIDE EVIDENCE** - List specific files, commits, code snippets
            - **TEST VERIFICATION** - Actually run the checks
            - **AUTO-CLOSE WHEN APPROPRIATE** - If fully resolved, close it
            - You have write permissions to close issues

  check-pr-comments:
    name: Check if All PR Comments Resolved
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.detect.outputs.should_run == 'true' && needs.detect.outputs.is_pr == 'true'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ needs.detect.outputs.issue_number }}
            });

            core.setOutput('branch', pr.data.head.ref);
            return pr.data;

      - name: Claude Check PR Comment Resolution
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ‚úÖ CHECK IF ALL PR COMMENTS ARE RESOLVED

            **PR:** #${{ needs.detect.outputs.issue_number }}
            **Branch:** ${{ steps.pr.outputs.branch }}

            ## YOUR MISSION - VERIFY ALL COMMENTS ADDRESSED:

            ### 1. Fetch All PR Comments
            ```bash
            gh pr view ${{ needs.detect.outputs.issue_number }} --json comments,reviews --jq '.' > /tmp/pr-feedback.json
            ```

            ### 2. Categorize All Comments

            **A. Regular Comments:**
            - General discussions
            - Questions
            - Suggestions

            **B. Review Comments (inline):**
            - Code-specific feedback
            - Line-by-line suggestions
            - Change requests

            **C. Review Threads:**
            - Conversation threads
            - Resolved vs unresolved status

            ### 3. Analyze Each Comment

            For each comment, determine:

            **‚úÖ ADDRESSED:**
            - Code was changed per suggestion
            - Question was answered
            - Concern was resolved
            - Marked as resolved in UI

            **‚ö†Ô∏è ACKNOWLEDGED BUT NOT IMPLEMENTED:**
            - Commenter agreed to defer
            - Out of scope for this PR
            - Will be addressed in follow-up

            **‚ùå UNADDRESSED:**
            - No response to comment
            - Code not changed per suggestion
            - Question unanswered
            - Concern still valid

            **ü§ñ AI HALLUCINATION:**
            - Comment based on incorrect understanding
            - Suggested change would break functionality
            - Misunderstanding of requirements
            - Invalid concern

            ### 4. Verify Code Changes

            For each code suggestion:
            - Check if the suggested file was modified
            - Verify the change matches the suggestion
            - Ensure change doesn't break tests

            ```bash
            gh pr diff ${{ needs.detect.outputs.issue_number }}
            ```

            ### 5. Resolve AI Hallucination Threads

            For comments that are AI hallucinations or incorrect:
            ```bash
            # Use GitHub GraphQL to resolve review threads
            # You have permission to resolve threads
            gh api graphql -f query='
              mutation {
                resolveReviewThread(input: {threadId: "<thread-id>"}) {
                  thread {
                    id
                    isResolved
                  }
                }
              }
            '
            ```

            ### 6. Create Comprehensive Report

            ```bash
            gh pr comment ${{ needs.detect.outputs.issue_number }} --body "$(cat <<'EOF'
            ## ‚úÖ PR Comment Resolution Check

            ### Summary
            - **Total Comments:** X
            - **Addressed:** X ‚úÖ
            - **Acknowledged (Deferred):** X ‚ö†Ô∏è
            - **Unaddressed:** X ‚ùå
            - **AI Hallucinations (Resolved):** X ü§ñ

            ### Detailed Analysis

            #### ‚úÖ Addressed Comments (X)
            1. **Comment by @user** ([link](url))
               - **Feedback:** [Summary]
               - **Resolution:** [How it was addressed]
               - **Code Change:** [File:line]

            2. **Comment by @user** ([link](url))
               - **Feedback:** [Summary]
               - **Resolution:** [How it was addressed]

            #### ‚ö†Ô∏è Acknowledged But Deferred (X)
            1. **Comment by @user** ([link](url))
               - **Feedback:** [Summary]
               - **Reason for Deferral:** [Why not in this PR]
               - **Follow-up:** [Created issue #X for tracking]

            #### ‚ùå Unaddressed Comments (X)
            1. **Comment by @user** ([link](url))
               - **Feedback:** [Summary]
               - **Status:** [Needs response/implementation]
               - **Recommendation:** [What should be done]

            #### ü§ñ AI Hallucinations Resolved (X)
            1. **Comment by @ai-bot** ([link](url))
               - **Incorrect Feedback:** [Summary]
               - **Why Invalid:** [Explanation]
               - **Thread Status:** Resolved ‚úÖ

            ### PR Readiness Assessment

            [Choose one:]

            #### ‚úÖ READY TO MERGE
            All comments have been addressed or resolved appropriately.
            - All valid feedback implemented
            - Questions answered
            - AI hallucinations dismissed
            - Deferred items tracked in follow-up issues

            **Recommendation:** This PR is ready to merge

            #### ‚ö†Ô∏è NEEDS ATTENTION
            Some comments still need to be addressed:
            - [Specific comment requiring action]
            - [Specific comment requiring action]

            **Recommendation:** Address these comments before merging

            #### ‚ùå NOT READY
            Significant unresolved feedback:
            - [Major concern not addressed]
            - [Critical change requested not implemented]

            **Recommendation:** More work needed before merge

            ### Actions Taken
            - [x] Analyzed all X comments
            - [x] Verified code changes against suggestions
            - [x] Resolved X AI hallucination threads
            - [x] Created follow-up issues for deferred items: [list]

            ---

            ü§ñ *Executed via @ready shortcut - PR comment resolution check*
            EOF
            )"
            ```

            ### 7. Auto-Resolve Invalid Comment Threads

            For any threads that are AI hallucinations or incorrect feedback, resolve them with a note:
            ```bash
            # Add dismissal comment, then resolve thread
            gh pr comment ${{ needs.detect.outputs.issue_number }} --body "Resolving this thread as the suggestion is based on incorrect understanding. [Brief explanation]"
            ```

            Then resolve via GraphQL API.

            ### 8. Create Follow-up Issues for Deferred Items

            If any comments are deferred (good ideas, but out of scope for this PR):
            ```bash
            gh issue create \
              --title "Follow-up: [Description from PR comment]" \
              --body "This is a follow-up from PR #${{ needs.detect.outputs.issue_number }}.

            Original comment by @user: [link to comment]

            [Description of what needs to be done]

            Related PR: #${{ needs.detect.outputs.issue_number }}" \
              --label "enhancement,follow-up"
            ```

            ## CRITICAL RULES:
            - **CHECK EVERY COMMENT** - Don't miss any feedback
            - **VERIFY CODE CHANGES** - Actually check if changes were made
            - **RESOLVE HALLUCINATIONS** - You have permission to resolve invalid threads
            - **CREATE FOLLOW-UPS** - Track deferred items in new issues
            - **BE SPECIFIC** - Link to exact comments and code changes
            - **COMPREHENSIVE REPORT** - Document everything clearly
            - You have write permissions to resolve threads and create issues

      - name: Success reaction
        if: success()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.issue_number }}
            });

            const readyComment = comments.data.find(c => c.body.includes('@ready'));
            if (readyComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: readyComment.id,
                content: 'hooray'
              });
            }
