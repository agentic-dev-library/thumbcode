name: "Shortcut: @rebase"

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  detect:
    name: Detect @rebase Command
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      base_branch: ${{ steps.check.outputs.base_branch }}
      head_branch: ${{ steps.check.outputs.head_branch }}

    steps:
      - name: Check for @rebase command
        id: check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const commentBody = context.payload.comment?.body || '';
            const shouldRun = commentBody.includes('@rebase');

            console.log(`Comment body: ${commentBody}`);
            console.log(`Should run: ${shouldRun}`);

            core.setOutput('should_run', shouldRun);

            if (!shouldRun) {
              return;
            }

            // Get PR details
            let prNumber = null;
            if (context.payload.issue?.pull_request) {
              prNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }

            if (!prNumber) {
              core.setFailed('@rebase can only be used on pull requests');
              return;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput('pr_number', prNumber);
            core.setOutput('base_branch', pr.data.base.ref);
            core.setOutput('head_branch', pr.data.head.ref);

            // Add reaction to indicate processing
            if (context.payload.comment?.id) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            }

  rebase:
    name: Auto-Rebase PR
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.detect.outputs.should_run == 'true'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.detect.outputs.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "claude-bot[bot]"
          git config user.email "claude-bot[bot]@users.noreply.github.com"

      - name: Fetch base branch
        run: |
          git fetch origin ${{ needs.detect.outputs.base_branch }}

      - name: Attempt auto-rebase
        id: rebase
        run: |
          echo "Attempting to rebase ${{ needs.detect.outputs.head_branch }} onto ${{ needs.detect.outputs.base_branch }}"

          if git rebase origin/${{ needs.detect.outputs.base_branch }}; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Rebase successful"
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            echo "Rebase has conflicts, will engage Claude for resolution"
            git rebase --abort
          fi

      - name: Push rebased branch (if no conflicts)
        if: steps.rebase.outputs.status == 'success'
        run: |
          git push --force-with-lease origin ${{ needs.detect.outputs.head_branch }}

      - name: Comment on success
        if: steps.rebase.outputs.status == 'success'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.pr_number }},
              body: 'âœ… **Auto-rebase successful!**\n\nRebased `${{ needs.detect.outputs.head_branch }}` onto `${{ needs.detect.outputs.base_branch }}` with no conflicts.\n\nðŸ¤– *Executed via @rebase shortcut*'
            });

      - name: Engage Claude for conflict resolution
        if: steps.rebase.outputs.status == 'conflict'
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ðŸ”€ AUTOMATIC REBASE WITH CONFLICT RESOLUTION

            **Task:** Rebase PR #${{ needs.detect.outputs.pr_number }} onto the latest `${{ needs.detect.outputs.base_branch }}` and resolve ALL conflicts automatically.

            **PR Branch:** ${{ needs.detect.outputs.head_branch }}
            **Base Branch:** ${{ needs.detect.outputs.base_branch }}

            ## INSTRUCTIONS:

            ### 1. Fetch Latest
            ```bash
            git fetch origin ${{ needs.detect.outputs.base_branch }}
            ```

            ### 2. Attempt Rebase
            ```bash
            git rebase origin/${{ needs.detect.outputs.base_branch }}
            ```

            ### 3. Resolve ALL Conflicts Automatically
            When conflicts occur:

            **A. List conflict files:**
            ```bash
            git diff --name-only --diff-filter=U
            ```

            **B. For EACH conflict file, analyze and resolve:**
            - Read the file with conflict markers
            - Understand both versions (HEAD vs incoming)
            - **Choose the correct resolution:**
              - Keep incoming changes if updating dependencies/configs
              - Keep both and merge if adding different features
              - Prefer ThumbCode style guidelines (CLAUDE.md)
              - Preserve functionality from both sides when possible

            **C. Edit the file to remove conflict markers:**
            - Remove `<<<<<<<`, `=======`, `>>>>>>>` markers
            - Keep the correct merged code
            - Ensure valid syntax (no broken code)

            **D. Mark as resolved:**
            ```bash
            git add <resolved-file>
            ```

            ### 4. Continue Rebase
            ```bash
            git rebase --continue
            ```

            Repeat steps 3-4 until rebase completes.

            ### 5. Verify No Breakage
            ```bash
            pnpm biome check --write .
            pnpm tsc --noEmit
            pnpm test --passWithNoTests
            ```

            If errors occur, fix them before pushing.

            ### 6. Force Push
            ```bash
            git push --force-with-lease origin ${{ needs.detect.outputs.head_branch }}
            ```

            ### 7. Comment on PR
            ```bash
            gh pr comment ${{ needs.detect.outputs.pr_number }} --body "$(cat <<'EOF'
            âœ… **Rebase completed with conflict resolution!**

            Rebased \`${{ needs.detect.outputs.head_branch }}\` onto \`${{ needs.detect.outputs.base_branch }}\`.

            ## Conflicts Resolved
            - [List files that had conflicts]
            - [Brief description of how conflicts were resolved]

            ## Verification
            - âœ… Biome linting passed
            - âœ… TypeScript type checking passed
            - âœ… Tests passing
            - âœ… Build successful

            ðŸ¤– *Executed via @rebase shortcut with Claude conflict resolution*
            EOF
            )"
            ```

            ## CRITICAL RULES:
            - **RESOLVE ALL CONFLICTS** - Don't leave any conflict markers
            - **PRESERVE FUNCTIONALITY** - Don't break existing code
            - **FOLLOW STYLE** - Use ThumbCode guidelines when choosing
            - **VERIFY FIRST** - Run checks before pushing
            - **ALWAYS PUSH** - Must force-push the rebased branch
            - **ALWAYS COMMENT** - Must comment on PR with summary

      - name: Handle failure
        if: failure()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.pr_number }},
              body: 'âŒ **Rebase failed**\n\nCould not automatically rebase this PR. Manual intervention may be required.\n\nðŸ¤– *Executed via @rebase shortcut*'
            });
