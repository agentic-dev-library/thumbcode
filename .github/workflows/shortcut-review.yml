name: "Shortcut: @review"

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  detect:
    name: Detect @review Command
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}

    steps:
      - name: Check for @review command
        id: check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const commentBody = context.payload.comment?.body || '';
            const shouldRun = commentBody.includes('@review');

            console.log(`Comment body: ${commentBody}`);
            console.log(`Should run: ${shouldRun}`);

            core.setOutput('should_run', shouldRun);

            if (!shouldRun) {
              return;
            }

            // Get PR number
            let prNumber = null;
            if (context.payload.issue?.pull_request) {
              prNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            }

            if (!prNumber) {
              core.setFailed('@review can only be used on pull requests');
              return;
            }

            core.setOutput('pr_number', prNumber);

            // Add reaction to indicate processing
            if (context.payload.comment?.id) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            }

  collaborative-review:
    name: Collaborative AI Review
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: needs.detect.outputs.should_run == 'true'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ needs.detect.outputs.pr_number }}
            });

            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('base', pr.data.base.ref);
            core.setOutput('title', pr.data.title);
            return pr.data;

      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Engage CodeRabbit AI for Review
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.pr_number }},
              body: `@coderabbitai full review

Please perform a comprehensive code review with focus on:

## Review Criteria

### 1. Code Quality
- **Clean Code Principles** - DRY, SOLID, KISS
- **Complexity** - Cyclomatic complexity, cognitive load
- **Readability** - Clear naming, proper structure
- **Maintainability** - Future-proof, easy to modify

### 2. Security
- **Vulnerabilities** - XSS, injection, CSRF
- **Secrets Management** - No hardcoded credentials
- **Authentication/Authorization** - Proper access controls
- **Input Validation** - Sanitization and validation

### 3. Performance
- **Algorithms** - Efficiency, time/space complexity
- **React Optimization** - Memoization, lazy loading, virtualization
- **Memory** - Leaks, unnecessary retention
- **Bundle Size** - Code splitting, tree shaking

### 4. TypeScript
- **Type Safety** - No \`any\` types, proper generics
- **Type Coverage** - Comprehensive typing
- **Type Correctness** - Accurate type definitions

### 5. ThumbCode Style (CRITICAL)
- **Design Tokens** - No hardcoded colors/fonts (check CLAUDE.md)
- **Organic Styling** - Asymmetric border-radius, no gradients
- **Warm Technical Palette** - Coral (#FF7059), Teal (#0D9488), Gold (#F5D563)
- **Typography** - Fraunces (display), Cabin (body), JetBrains Mono (code)
- **Brand Compliance** - Follows CLAUDE.md playbook

### 6. Testing
- **Coverage** - Adequate test coverage
- **Edge Cases** - Boundary conditions, error cases
- **Test Quality** - Meaningful, maintainable tests

### 7. Documentation
- **Code Comments** - Complex logic explained
- **API Docs** - JSDoc for public APIs
- **README Updates** - Reflects changes

Please provide:
- **Line-by-line comments** for specific issues
- **Summary review** with overall assessment
- **Actionable suggestions** with code examples
- **Priority** for each issue (critical, high, medium, low)

This is part of a collaborative review with Claude AI. Please be thorough and specific.`
            });

      - name: Wait for CodeRabbit Initial Response
        run: sleep 30

      - name: Claude Collaborative Review
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          track_progress: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ü§ù COLLABORATIVE REVIEW WITH CODERABBIT AI

            **Context:** You are collaborating with CodeRabbit AI on a comprehensive PR review. CodeRabbit has been engaged and will provide its analysis. You should provide complementary deep analysis focused on ThumbCode-specific concerns.

            **PR:** #${{ needs.detect.outputs.pr_number }}
            **Title:** ${{ steps.pr.outputs.title }}
            **Branch:** ${{ steps.pr.outputs.branch }}
            **Base:** ${{ steps.pr.outputs.base }}

            ## YOUR MISSION - DEEP COLLABORATIVE REVIEW:

            ### 1. Fetch Full PR Context
            ```bash
            gh pr view ${{ needs.detect.outputs.pr_number }} --json title,body,files,comments,reviews,commits
            gh pr diff ${{ needs.detect.outputs.pr_number }}
            ```

            ### 2. Read ALL Changed Files
            Get the list of changed files and read each one completely:
            ```bash
            gh pr view ${{ needs.detect.outputs.pr_number }} --json files --jq '.files[].path'
            ```

            For each file, understand:
            - What changed and why
            - How it fits into the broader codebase
            - Potential side effects
            - Integration points

            ### 3. ThumbCode-Specific Deep Analysis

            **A. CLAUDE.md Compliance (CRITICAL):**
            - [ ] Uses design tokens from tokens.json (no hardcoded `#FF0000` colors)
            - [ ] Organic styling with asymmetric border-radius
            - [ ] NO gradients anywhere (backgrounds, buttons, cards)
            - [ ] Warm Technical palette: Coral/Teal/Gold on Charcoal
            - [ ] Typography: Fraunces (display), Cabin (body), NOT Inter/Roboto
            - [ ] Proper file naming (kebab-case files, PascalCase components)
            - [ ] Conventional commits format

            **B. Architecture Alignment:**
            - Read ARCHITECTURE.md to understand technical decisions
            - Verify changes align with architecture patterns
            - Check for violations of established patterns
            - Evaluate impact on overall system design

            **C. Roadmap Fit:**
            - Read PROJECT-STATUS.md to understand current phase
            - Does this PR align with current priorities?
            - Is it the right time for this change?
            - Dependencies on future work?

            **D. Code Quality Beyond Basics:**
            - **Cognitive Complexity** - Is logic easy to understand?
            - **Abstraction Level** - Right balance (not over/under-engineered)?
            - **Error Handling** - Comprehensive, user-friendly?
            - **Edge Cases** - All scenarios covered?
            - **React Best Practices** - Hooks, effects, memoization correct?

            **E. Mobile-First Considerations:**
            - **Touch Targets** - Minimum 44x44px tap areas?
            - **Responsive** - Works on all mobile screen sizes?
            - **Performance** - Optimized for mobile devices?
            - **Accessibility** - Screen reader friendly?

            ### 4. Review CodeRabbit's Feedback
            ```bash
            gh pr view ${{ needs.detect.outputs.pr_number }} --json comments --jq '.comments[] | select(.author.login == "coderabbitai[bot]") | .body'
            ```

            - Understand CodeRabbit's concerns
            - Add complementary analysis
            - Don't duplicate points
            - Build on CodeRabbit's findings with ThumbCode context

            ### 5. Add Inline Review Comments
            For each significant issue, add a review comment:
            ```bash
            gh pr review ${{ needs.detect.outputs.pr_number }} --comment --body "$(cat <<'EOF'
            ## ü§ñ Claude Collaborative Review

            ### ThumbCode Style Compliance
            [Analysis of CLAUDE.md compliance]

            ### Architecture Alignment
            [Analysis of architectural fit]

            ### Code Quality Insights
            [Deep code quality analysis]

            ### Recommendations

            #### Critical Issues üö®
            1. [Issue with specific file:line reference]
               - **Problem:** [Description]
               - **Impact:** [Why this matters]
               - **Solution:** [How to fix with code example]

            #### High Priority ‚ö†Ô∏è
            1. [Issue with specific file:line reference]
               - **Problem:** [Description]
               - **Fix:** [Solution]

            #### Suggestions üí°
            1. [Enhancement with file:line reference]
               - **Current:** [What exists]
               - **Suggested:** [Improvement]
               - **Benefit:** [Why it's better]

            ### Collaboration Notes
            This review complements CodeRabbit AI's analysis with:
            - ThumbCode-specific style guidelines enforcement
            - Architecture and roadmap alignment verification
            - Mobile-first and accessibility considerations
            - React Native/Expo best practices

            Please review both AI assessments for comprehensive feedback.

            ---

            ü§ñ *Executed via @review shortcut - Claude deep analysis*
            EOF
            )"
            ```

            ### 6. Run Automated Checks
            ```bash
            pnpm biome check .
            pnpm tsc --noEmit
            pnpm test --passWithNoTests
            ```

            Report results in your review.

            ### 7. Suggest Specific File Changes (if appropriate)
            If there are clear fixes you can recommend with code examples, include them in your review comments.

            ## CRITICAL RULES:
            - **COMPLEMENT CODERABBIT** - Don't duplicate, add ThumbCode-specific insights
            - **BE THOROUGH** - Review every changed file completely
            - **BE SPECIFIC** - Reference exact file:line for issues
            - **PROVIDE EXAMPLES** - Show code snippets for fixes
            - **CHECK STYLE** - CLAUDE.md compliance is non-negotiable
            - **CONTEXT MATTERS** - Consider architecture, roadmap, mobile-first
            - **COLLABORATIVE** - Build on CodeRabbit's findings, don't compete

      - name: Success reaction
        if: success()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.pr_number }}
            });

            const reviewComment = comments.data.find(c => c.body.includes('@review'));
            if (reviewComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: reviewComment.id,
                content: 'hooray'
              });
            }
