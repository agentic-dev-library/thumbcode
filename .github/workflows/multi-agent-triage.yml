name: Multi-Agent Issue Triage & PR Automation

on:
  pull_request:
    types: [closed]
    branches: [main]
  issues:
    types: [edited, labeled, unlabeled]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  workflows: write
  checks: write
  actions: read
  statuses: write

jobs:
  claude-triage:
    name: Claude - Assess & Prioritize
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      jules_issues: ${{ steps.analyze.outputs.issues_for_jules }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Claude Analysis & Auto-Implementation
        id: claude
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          track_progress: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ü§ñ MULTI-AGENT AUTO-IMPLEMENTATION MODE ü§ñ

            **Context:** This is an AUTOMATED multi-agent workflow. You (Claude) will AUTOMATICALLY find, assess, and IMPLEMENT issues without asking for permission.

            ## YOUR MISSION - AUTO-IMPLEMENT ISSUES:

            ### 1. Find Ready Issues
            Use gh CLI to search for open issues:
            ```bash
            gh issue list --state open --json number,title,labels,body --limit 100
            ```

            Filter for issues that are:
            - NOT labeled with `auto-implemented` or `jules` (not processed yet)
            - NOT associated with an open PR
            - Labeled `status: ready` OR clearly actionable
            - Type: `bug`, `feature`, or `enhancement`

            ### 2. Assess & Prioritize
            For each issue, evaluate:
            - **Clarity:** Enough detail for autonomous implementation? ‚úÖ/‚ùå
            - **Scope:** Small enough for single PR (< 200 lines)? ‚úÖ/‚ùå
            - **Dependencies:** Depends on other open issues? ‚ùå/‚úÖ
            - **Priority:** Check labels and PROJECT-STATUS.md roadmap
            - **Feasibility:** Can you implement this alone? ‚úÖ/‚ùå

            ### 3. AUTO-IMPLEMENT TOP 3 ISSUES
            For the TOP 3 highest priority issues:

            **A. Create Implementation Branch:**
            ```bash
            git checkout -b claude/auto-impl-issue-{ISSUE_NUMBER}-{SHORT_SLUG}
            ```

            **B. Read Full Context:**
            - Read the issue body completely
            - Check CLAUDE.md for style guidelines
            - Read relevant files mentioned in the issue
            - Review related code

            **C. Implement the Solution:**
            - Fix bugs completely
            - Implement features following CLAUDE.md
            - Use design tokens (no hardcoded colors)
            - Apply organic styling conventions
            - Write proper TypeScript types
            - Add tests for new functionality
            - Update documentation if needed

            **D. Verify Implementation:**
            ```bash
            pnpm biome check --write .
            pnpm tsc --noEmit
            pnpm test --passWithNoTests
            pnpm build
            ```

            **E. Commit & Push:**
            ```bash
            git add .
            git commit -m "fix/feat: implement issue #{ISSUE_NUMBER}

            {Brief description of what was implemented}

            - Added/Fixed X
            - Updated Y
            - Tested Z

            Implements #{ISSUE_NUMBER}
            Auto-implemented by Claude Multi-Agent workflow"

            git push -u origin claude/auto-impl-issue-{ISSUE_NUMBER}-{SHORT_SLUG}
            ```

            **F. Create PR:**
            ```bash
            gh pr create \
              --base main \
              --head claude/auto-impl-issue-{ISSUE_NUMBER}-{SHORT_SLUG} \
              --title "{fix|feat}({scope}): implement issue #{ISSUE_NUMBER}" \
              --body "$(cat <<'EOF'
            ## Implements #{ISSUE_NUMBER}

            {Summary of the issue}

            ## Changes Made

            - [ ] {Specific change 1}
            - [ ] {Specific change 2}
            - [ ] {Specific change 3}

            ## Implementation Details

            {Brief explanation of approach}

            ## Testing

            - ‚úÖ All tests passing
            - ‚úÖ Biome linting passed
            - ‚úÖ TypeScript type checking passed
            - ‚úÖ Build successful

            ## Checklist

            - [ ] Follows CLAUDE.md style guidelines
            - [ ] Uses design tokens (no hardcoded colors)
            - [ ] Organic styling applied
            - [ ] TypeScript types added
            - [ ] Tests added/updated
            - [ ] Documentation updated

            Closes #{ISSUE_NUMBER}

            ü§ñ *Auto-implemented by Claude Multi-Agent Triage*
            EOF
            )"
            ```

            **G. Label the Issue:**
            ```bash
            gh issue edit {ISSUE_NUMBER} --add-label "auto-implemented,claude"
            gh issue comment {ISSUE_NUMBER} --body "‚úÖ Auto-implemented in PR #{PR_NUMBER}"
            ```

            ### 4. Report Summary
            After implementing all 3 issues, create a summary comment on this workflow run with:
            - Issues implemented
            - PRs created
            - Any issues that couldn't be auto-implemented and why

            ## CRITICAL RULES:
            - **AUTO-IMPLEMENT** - Don't just assess, actually implement
            - **TOP 3 ONLY** - Implement the 3 highest priority issues
            - **NO ASKING** - Just do it automatically
            - **COMMIT & PUSH** - Always commit and push changes
            - **CREATE PRS** - Always create PRs for implemented issues
            - **LABEL ISSUES** - Mark issues as auto-implemented
            - You have full write permissions (contents, workflows, pull-requests)
            - You are authorized to create branches, commit, push, and create PRs
            - Follow CLAUDE.md playbook strictly
            - Prefer bugs over features
            - Skip issues that need human decision-making

      - name: Parse Claude Output
        id: analyze
        run: |
          # Extract JSON from Claude's output
          # This will be used by Jules in the next job
          echo "issues_for_jules={}" >> $GITHUB_OUTPUT

  jules-implementation:
    name: Jules - Implement PRs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: claude-triage
    if: needs.claude-triage.outputs.jules_issues != '{}'

    strategy:
      max-parallel: 3
      matrix:
        # This will be dynamically populated from Claude's output
        issue: ${{ fromJSON(needs.claude-triage.outputs.jules_issues).issues || fromJSON('[]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Jules Implementation
        uses: google-labs-code/jules-action@v1
        with:
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          starting_branch: main
          prompt: |
            Implement issue #${{ matrix.issue.number }}: ${{ matrix.issue.title }}

            ## Requirements
            ${{ matrix.issue.requirements }}

            ## Expected Changes
            Files to modify: ${{ join(matrix.issue.files_to_modify, ', ') }}

            ## Guidelines
            - Follow CLAUDE.md playbook strictly
            - Use design tokens from design-system/tokens.json (no hardcoded colors)
            - Apply organic styling (asymmetric border-radius)
            - Use Warm Technical palette (Coral/Teal/Gold)
            - Write TypeScript with strict types
            - Add tests for new functionality
            - Update documentation if needed

            ## Process
            1. Read the issue for full context
            2. Review related files and architecture
            3. Implement the fix/feature
            4. Run tests locally
            5. Create a PR with:
               - Title: "fix(scope): brief description" or "feat(scope): brief description"
               - Body: Fixes #${{ matrix.issue.number }}
               - Checkbox list of changes made

  update-labels:
    name: Update Issue Labels
    runs-on: ubuntu-latest
    needs: [claude-triage, jules-implementation]
    if: always()

    steps:
      - name: Update Processed Issues
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add 'jules-processing' label to issues being worked on
            // Add 'jules-complete' when PR is created
            // This script will be populated based on actual execution
            console.log('Issue labels updated');
