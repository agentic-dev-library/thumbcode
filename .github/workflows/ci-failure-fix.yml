name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write

jobs:
  auto-fix:
    name: Claude Auto-Fix CI Failures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "claude-bot[bot]"
          git config user.email "claude-bot[bot]@users.noreply.github.com"

      - name: Create fix branch
        id: branch
        run: |
          FIX_BRANCH="claude-auto-fix-ci-${{ github.event.workflow_run.id }}"
          echo "branch_name=$FIX_BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$FIX_BRANCH"

      - name: Get failure logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get run details
          RUN_ID="${{ github.event.workflow_run.id }}"
          echo "run_url=https://github.com/${{ github.repository }}/actions/runs/$RUN_ID" >> $GITHUB_OUTPUT

          # Get failed jobs
          FAILED_JOBS=$(gh api "/repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs" \
            --jq '.jobs[] | select(.conclusion == "failure") | .name' | tr '\n' ',' | sed 's/,$//')
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT

          # Download logs
          mkdir -p /tmp/logs
          gh run download "$RUN_ID" --dir /tmp/logs || true

          # Combine logs
          find /tmp/logs -type f -name "*.txt" -exec cat {} \; > /tmp/combined-logs.txt || echo "No logs found"
          echo "logs_path=/tmp/combined-logs.txt" >> $GITHUB_OUTPUT

      - name: Claude Fix CI
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh
          prompt: |
            /fix-ci

            The CI workflow failed. Please analyze the errors and fix them.

            **Run URL:** ${{ steps.logs.outputs.run_url }}
            **Failed Jobs:** ${{ steps.logs.outputs.failed_jobs }}
            **Branch:** ${{ github.event.workflow_run.head_branch }}
            **Repository:** ${{ github.repository }}

            **Error Logs Path:** ${{ steps.logs.outputs.logs_path }}

            Please use the read_file tool to open this file and analyze the error logs.

            Please:
            1. Analyze the failure logs to identify root causes
            1. Analyze the failure logs to identify root causes
            2. Fix the issues in the code
            3. Run the failing commands locally to verify fixes
            4. Commit the changes with a descriptive message
            5. Push to the branch: ${{ steps.branch.outputs.branch_name }}

            Focus on:
            - Lint errors (fix with Biome)
            - Type errors (proper TypeScript types)
            - Test failures (fix logic or update tests)
            - Build errors (dependency or configuration issues)
