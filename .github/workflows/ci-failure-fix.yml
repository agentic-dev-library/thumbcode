name: Auto Fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write
  checks: write

jobs:
  auto-fix:
    name: Claude Auto-Fix CI Failures
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-') &&
      github.event.workflow_run.head_repository.full_name == github.repository

    steps:
      - name: Verify not from fork
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const headRepo = '${{ github.event.workflow_run.head_repository.full_name }}';
            const baseRepo = '${{ github.repository }}';
            if (headRepo !== baseRepo) {
              core.setFailed(`Refusing to run on forked PR code. Head: ${headRepo}, Base: ${baseRepo}`);
            }
            console.log(`Verified: ${headRepo} matches ${baseRepo}`);

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "claude-bot[bot]"
          git config user.email "claude-bot[bot]@users.noreply.github.com"

      - name: Create fix branch
        id: branch
        run: |
          FIX_BRANCH="claude-auto-fix-ci-${{ github.event.workflow_run.id }}"
          echo "branch_name=$FIX_BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$FIX_BRANCH"

      - name: Get failure logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get run details
          RUN_ID="${{ github.event.workflow_run.id }}"
          echo "run_url=https://github.com/${{ github.repository }}/actions/runs/$RUN_ID" >> $GITHUB_OUTPUT

          # Get failed jobs
          FAILED_JOBS=$(gh api "/repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs" \
            --jq '.jobs[] | select(.conclusion == "failure") | .name' | tr '\n' ',' | sed 's/,$//')
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT

          # Download logs
          mkdir -p /tmp/logs
          gh run download "$RUN_ID" --dir /tmp/logs || true

          # Combine logs
          find /tmp/logs -type f -name "*.txt" -exec cat {} \; > /tmp/combined-logs.txt || echo "No logs found"
          echo "logs_path=/tmp/combined-logs.txt" >> $GITHUB_OUTPUT

      - name: Claude Auto-Heal CI Failures
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            ðŸš¨ AUTOMATIC HEALING MODE - NO RECOMMENDATIONS, ONLY FIXES ðŸš¨

            The CI workflow failed. You MUST automatically fix ALL errors without asking for permission.

            **Run URL:** ${{ steps.logs.outputs.run_url }}
            **Failed Jobs:** ${{ steps.logs.outputs.failed_jobs }}
            **Original Branch:** ${{ github.event.workflow_run.head_branch }}
            **Fix Branch:** ${{ steps.branch.outputs.branch_name }}
            **Repository:** ${{ github.repository }}
            **Error Logs Path:** ${{ steps.logs.outputs.logs_path }}

            ## CRITICAL INSTRUCTIONS - FOLLOW EXACTLY:

            1. **READ LOGS**: Use read_file to open ${{ steps.logs.outputs.logs_path }} and analyze ALL errors

            2. **IDENTIFY ROOT CAUSES**: Categorize errors:
               - Lint errors (Biome violations)
               - Type errors (TypeScript issues)
               - Test failures (Jest failures)
               - Build errors (Expo/dependency issues)
               - Import errors (missing modules)

            3. **AUTO-FIX ALL ISSUES** (DO NOT ASK, JUST FIX):
               - Lint errors: Run `pnpm biome check --write .` to auto-fix
               - Type errors: Fix TypeScript types manually
               - Test failures: Fix logic OR update snapshots/tests
               - Build errors: Fix imports, add missing dependencies
               - If workflow files need fixing, fix them too (you have workflows: write permission)

            4. **VERIFY FIXES**: Run the failing commands locally:
               ```bash
               pnpm biome check .
               pnpm tsc --noEmit
               pnpm test --passWithNoTests
               pnpm build
               ```

            5. **COMMIT EVERYTHING**: Git add ALL changes and commit with:
               ```bash
               git add .
               git commit -m "fix(ci): auto-heal CI failures

               - Fixed lint errors via Biome
               - Resolved TypeScript type issues
               - Fixed test failures
               - Resolved build errors

               Auto-healed by Claude CI Failure Fix workflow
               Run: ${{ steps.logs.outputs.run_url }}"
               ```

            6. **PUSH FIXES**: Push to the fix branch:
               ```bash
               git push -u origin ${{ steps.branch.outputs.branch_name }}
               ```

            7. **CREATE PR**: Create a pull request using gh CLI:
               ```bash
               gh pr create \
                 --base "${{ github.event.workflow_run.head_branch }}" \
                 --head "${{ steps.branch.outputs.branch_name }}" \
                 --title "fix(ci): Auto-heal CI failures from run #${{ github.event.workflow_run.id }}" \
                 --body "$(cat <<'EOF'
               ## Auto-Healed CI Failures

               This PR automatically fixes all CI failures from run #${{ github.event.workflow_run.id }}.

               **Original Branch:** ${{ github.event.workflow_run.head_branch }}
               **Failed Jobs:** ${{ steps.logs.outputs.failed_jobs }}
               **Run URL:** ${{ steps.logs.outputs.run_url }}

               ## Changes Made

               - [ ] Fixed lint errors (Biome)
               - [ ] Resolved TypeScript type issues
               - [ ] Fixed test failures
               - [ ] Resolved build errors
               - [ ] Updated workflows if needed

               ## Verification

               All fixes have been verified by running:
               - âœ… `pnpm biome check .`
               - âœ… `pnpm tsc --noEmit`
               - âœ… `pnpm test`
               - âœ… `pnpm build`

               **Auto-generated by Claude CI Auto-Heal workflow**
               EOF
               )"
               ```

            ## REMEMBER:
            - **NO RECOMMENDATIONS** - Only actual fixes
            - **COMMIT & PUSH** - Always commit and push your changes
            - **CREATE PR** - Always create the PR
            - **AUTO-HEAL** - Fix everything automatically
            - You have full permissions: contents:write, workflows:write, pull-requests:write
            - You are authorized to modify ANY file including workflows
            - Bot users (claude-bot[bot]) are allowed to push
