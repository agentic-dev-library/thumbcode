name: CD

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'capacitor.config.ts'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'capacitor.config.ts'
      - 'package.json'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'web'
        type: choice
        options:
          - web

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Build Web + Capacitor Sync
  # ============================================
  build-and-sync:
    name: Build Web + Capacitor Sync
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Build web
        run: pnpm build
        env:
          CI: true

      - name: Capacitor sync
        run: npx cap sync

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: success()
        with:
          name: web-build
          path: dist/
          retention-days: 7

  # ============================================
  # NOTE: Native App Submissions
  # ============================================
  # Production submission jobs are not yet configured.
  # See issue #66 for required credentials and setup.
  #
  # Current release strategy:
  # - Web staging: Automatic via Render.com (render.yaml)
  # - Native builds: Use Capacitor CLI locally
  #   - iOS:     npx cap open ios
  #   - Android: npx cap open android
