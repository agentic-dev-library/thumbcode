name: CD

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'app.json'
      - 'eas.json'
      - 'package.json'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'app.json'
      - 'eas.json'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios
          - web
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # EAS Update for PRs (OTA Updates)
  # ============================================
  eas-update:
    name: EAS Update (PR Preview)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check for EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::warning::EXPO_TOKEN secret is not configured. Skipping EAS update."
            echo "Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 0
          fi

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Create preview update
        uses: expo/expo-github-action/preview@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          command: eas update --auto

  # ============================================
  # EAS Build - Android
  # ============================================
  build-android:
    name: Build Android
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check for EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::error::EXPO_TOKEN secret is required for EAS builds"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android
        run: |
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          eas build --platform android --profile $PROFILE --non-interactive --no-wait

  # ============================================
  # EAS Build - iOS
  # ============================================
  build-ios:
    name: Build iOS
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check for EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::error::EXPO_TOKEN secret is required for EAS builds"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build iOS
        run: |
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          eas build --platform ios --profile $PROFILE --non-interactive --no-wait

  # ============================================
  # Production Deployment (App Store / Play Store)
  # ============================================
  submit-android:
    name: Submit to Play Store
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.profile == 'production' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android')
    needs: build-android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        run: eas submit --platform android --latest --non-interactive

  submit-ios:
    name: Submit to App Store
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.profile == 'production' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios')
    needs: build-ios
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup ThumbCode environment
        uses: ./.github/actions/setup-thumbcode

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store
        run: eas submit --platform ios --latest --non-interactive
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
