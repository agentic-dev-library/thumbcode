name: "Shortcut: @triage"

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write

jobs:
  detect:
    name: Detect @triage Command
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      is_pr: ${{ steps.check.outputs.is_pr }}

    steps:
      - name: Check for @triage command
        id: check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const commentBody = context.payload.comment?.body || '';
            const shouldRun = commentBody.includes('@triage');

            console.log(`Comment body: ${commentBody}`);
            console.log(`Should run: ${shouldRun}`);

            core.setOutput('should_run', shouldRun);

            if (!shouldRun) {
              return;
            }

            const issueNumber = context.payload.issue.number;
            const isPR = !!context.payload.issue.pull_request;

            core.setOutput('issue_number', issueNumber);
            core.setOutput('is_pr', isPR);

            // Add reaction to indicate processing
            if (context.payload.comment?.id) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            }

  triage:
    name: Multi-AI Triage
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.detect.outputs.should_run == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Engage CodeRabbit AI
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const isPR = ${{ needs.detect.outputs.is_pr }};
            const issueNumber = ${{ needs.detect.outputs.issue_number }};

            let triageRequest = '';

            if (isPR) {
              triageRequest = `@coderabbitai review

Please perform a comprehensive review of this pull request with focus on:

1. **Code Quality** - DRY, SOLID, clean code principles
2. **Security** - Vulnerabilities, injection risks, secrets exposure
3. **Performance** - Optimization opportunities, memory leaks
4. **TypeScript** - Type safety, proper typing (no \`any\`)
5. **ThumbCode Style** - Design tokens, organic styling, brand guidelines (see CLAUDE.md)
6. **Testing** - Test coverage, edge cases
7. **Documentation** - Missing docs, outdated comments

Please provide actionable feedback with specific suggestions.`;
            } else {
              triageRequest = `@coderabbitai analyze

Please analyze this issue and provide:

1. **Category** - Bug, feature, enhancement, documentation, question
2. **Priority** - High, medium, low (based on impact and urgency)
3. **Complexity** - Simple, moderate, complex (estimate LOC and files affected)
4. **Requirements** - Clear requirements or ask for clarification
5. **Implementation Approach** - Recommended solution approach
6. **Related Issues/PRs** - Search for duplicates or related work
7. **Checklist** - Steps needed to implement/resolve

Please also suggest appropriate labels and milestones.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: triageRequest
            });

      - name: Engage Claude for Triage
        uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c # v1.0.30
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allow_any_user: true
          claude_args: |
            --allowed-tools=edit_file,write_file,read_file,list_directory,search_files,bash
            --bash-allowlist=git,pnpm,npm,npx,gh,biome,tsc,jest,expo
          prompt: |
            üîç COLLABORATIVE TRIAGE WITH CODERABBIT AI

            **Context:** This is a collaborative triage. CodeRabbit AI has been engaged and will provide its analysis. You (Claude) should provide complementary analysis from the ThumbCode project perspective.

            **Issue/PR:** #${{ needs.detect.outputs.issue_number }}
            **Type:** ${{ needs.detect.outputs.is_pr == 'true' && 'Pull Request' || 'Issue' }}

            ## YOUR MISSION:

            ${{ needs.detect.outputs.is_pr == 'true' && '### PR Triage' || '### Issue Triage' }}

            ### 1. Fetch Full Context
            ```bash
            ${{ needs.detect.outputs.is_pr == 'true' && 'gh pr view ${{ needs.detect.outputs.issue_number }} --json title,body,files,comments,reviews,commits' || 'gh issue view ${{ needs.detect.outputs.issue_number }} --json title,body,labels,comments,assignees' }}
            ```

            ### 2. Read ThumbCode Documentation
            - Read CLAUDE.md for style guidelines
            - Read PROJECT-STATUS.md for roadmap alignment
            - Read ARCHITECTURE.md for technical context

            ### 3. Analyze Against ThumbCode Standards

            ${{ needs.detect.outputs.is_pr == 'true' && '**For PRs:**
            - Does it follow CLAUDE.md playbook?
            - Uses design tokens (no hardcoded colors)?
            - Organic styling (asymmetric borders, no gradients)?
            - Warm Technical palette (Coral/Teal/Gold)?
            - Fraunces/Cabin fonts (not Inter/Roboto)?
            - Proper TypeScript types (no \`any\`)?
            - Follows conventional commits?
            - Aligns with current project phase?
            - Has tests?
            - Updates documentation?' || '**For Issues:**
            - Aligns with ThumbCode mission and vision?
            - Fits current project phase from PROJECT-STATUS.md?
            - Clear and actionable requirements?
            - Feasible for AI implementation?
            - Dependencies on other issues?
            - Estimated complexity?
            - Priority based on roadmap?' }}

            ### 4. Add Labels
            Use gh CLI to add appropriate labels:
            ```bash
            gh issue edit ${{ needs.detect.outputs.issue_number }} --add-label "<labels>"
            ```

            Labels to consider:
            - Type: bug, feature, enhancement, documentation, question
            - Priority: priority: high, priority: medium, priority: low
            - Area: area: agents, area: ui, area: docs, area: ci, area: design, area: git
            - Status: status: needs-triage, status: ready, status: blocked

            ### 5. Comment with Analysis
            ```bash
            gh ${{ needs.detect.outputs.is_pr == 'true' && 'pr' || 'issue' }} comment ${{ needs.detect.outputs.issue_number }} --body "$(cat <<'EOF'
            ## ü§ñ Claude Triage Analysis

            ### ThumbCode Alignment
            - **Mission Alignment:** [Yes/No - brief explanation]
            - **Roadmap Fit:** [Current phase alignment]
            - **Style Compliance:** [Follows CLAUDE.md guidelines?]

            ### Assessment
            - **Category:** [Bug/Feature/Enhancement/Docs/Question]
            - **Priority:** [High/Medium/Low] - [Why?]
            - **Complexity:** [Simple/Moderate/Complex] - [Estimate]
            - **AI-Implementable:** [Yes/No/Partial]

            ### Recommendations
            - [Specific recommendation 1]
            - [Specific recommendation 2]
            - [Specific recommendation 3]

            ### Next Steps
            - [ ] [Action item 1]
            - [ ] [Action item 2]
            - [ ] [Action item 3]

            ### Labels Applied
            \`[List of labels added]\`

            ---

            üí° **Note:** CodeRabbit AI has also been engaged for collaborative analysis. Review both assessments for comprehensive triage.

            ü§ñ *Executed via @triage shortcut - Claude analysis*
            EOF
            )"
            ```

            ### 6. Check for Duplicates
            Search for similar issues/PRs:
            ```bash
            gh issue list --search "is:issue is:open [key terms from title]" --json number,title
            gh pr list --search "is:pr is:open [key terms from title]" --json number,title
            ```

            If duplicates found, mention them in your comment.

            ## CRITICAL RULES:
            - **COMPLEMENT CODERABBIT** - Don't duplicate, add ThumbCode-specific insights
            - **ADD LABELS** - Always categorize with appropriate labels
            - **BE SPECIFIC** - Provide actionable recommendations
            - **CHECK ALIGNMENT** - Verify against CLAUDE.md and roadmap
            - **SEARCH DUPLICATES** - Always check for similar issues/PRs
            - You have full write permissions to label and comment

      - name: Success reaction
        if: success()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.detect.outputs.issue_number }}
            });

            const triageComment = comments.data.find(c => c.body.includes('@triage'));
            if (triageComment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: triageComment.id,
                content: '+1'
              });
            }
